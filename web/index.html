<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä¸­æ–‡ç¦»çº¿è¯†åˆ« Â· Vosk + Flask</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
  button{padding:8px 12px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
  #out{white-space:pre-wrap;border:1px solid #ddd;border-radius:10px;padding:10px;min-height:80px;background:#fafafa}
  .meta{color:#555;font-size:14px}
  .note{color:#444;margin:6px 0 12px}
  .grid{display:grid;grid-template-columns: 180px 1fr;gap:6px 12px}
  .k{color:#666}
  .v{color:#111}
</style>
</head>
<body>
<h2>ğŸ¤ ä¸­æ–‡ç¦»çº¿è¯†åˆ«ï¼ˆä¸Šä¼ å¹¶å¯ç›´æ¥æ’­æ”¾ï¼‰</h2>
<p id="limitNote" class="note">ğŸ“ æœ€å¤§ä¸Šä¼ ï¼š<b id="maxTip">25 MB</b>ã€‚è¶…è¿‡å°†è¢«æ‹’ç»ã€‚</p>

<div class="row">
  <input id="file" type="file" accept="audio/*">
  <button id="uploadBtn">ä¸Šä¼ è¯†åˆ«</button>
</div>

<div class="row" id="playerRow" style="display:none">
  <audio id="player" controls preload="metadata"></audio>
  <span id="meta" class="meta"></span>
</div>

<h3 style="margin:14px 0 6px">ğŸ“ è¯†åˆ«ç»“æœ</h3>
<div id="textOut" style="border:1px solid #ddd;border-radius:10px;padding:10px;min-height:60px;background:#fafafa">ç­‰å¾…è¯†åˆ«â€¦</div>

<h3 style="margin:14px 0 6px">ğŸ“Š æŒ‡æ ‡</h3>
<div id="stats" class="grid">
  <div class="k">ç«¯åˆ°ç«¯è€—æ—¶</div><div class="v" id="latency">-</div>
  <div class="k">è½¬ç è€—æ—¶</div><div class="v" id="decode">-</div>
  <div class="k">è¯†åˆ«è€—æ—¶</div><div class="v" id="recognize">-</div>
  <div class="k">CPU æ—¶é—´</div><div class="v" id="cpuTime">-</div>
  <div class="k">CPU å æ¯”(ä¼°ç®—)</div><div class="v" id="cpuPct">-</div>
  <div class="k">RSS å†…å­˜</div><div class="v" id="rss">-</div>
  <div class="k">RSS å¢é‡</div><div class="v" id="rssDelta">-</div>
  <div class="k">éŸ³é¢‘æ—¶é•¿</div><div class="v" id="aSec">-</div>
  <div class="k">æ–‡ä»¶å¤§å°</div><div class="v" id="fSize">-</div>
  <div class="k">å‰ç«¯å¾€è¿”è€—æ—¶</div><div class="v" id="rt">-</div>
</div>

<script>
const outText = document.getElementById('textOut');
const file = document.getElementById('file');
const uploadBtn = document.getElementById('uploadBtn');
const playerRow = document.getElementById('playerRow');
const player = document.getElementById('player');
const meta = document.getElementById('meta');
const maxTip = document.getElementById('maxTip');

const el = id => document.getElementById(id);

// æŒ‡æ ‡å…ƒç´ 
const E = {
  latency: el('latency'),
  decode: el('decode'),
  recognize: el('recognize'),
  cpuTime: el('cpuTime'),
  cpuPct: el('cpuPct'),
  rss: el('rss'),
  rssDelta: el('rssDelta'),
  aSec: el('aSec'),
  fSize: el('fSize'),
  rt: el('rt'),
};

let objectURL = null;
let MAX_MB = 25; // ä¼šåœ¨ init() é‡Œç”± /api/health è¦†ç›–
let MAX_BYTES = MAX_MB * 1024 * 1024;

function bytesToSize(bytes){
  if(bytes === undefined || bytes === null) return '';
  const k = 1024, sizes = ['B','KB','MB','GB'];
  const i = Math.min(sizes.length-1, Math.floor(Math.log(bytes)/Math.log(k)));
  return (bytes/Math.pow(k,i)).toFixed(i ? 1 : 0) + ' ' + sizes[i];
}

function formatSec(s){
  if(isNaN(s)) return '';
  const m = Math.floor(s/60), sec = Math.round(s%60);
  return `${m}:${sec.toString().padStart(2,'0')}`;
}

function setStats(obj){
  E.latency.textContent  = obj.latency_ms != null ? `${obj.latency_ms} ms` : '-';
  E.decode.textContent   = obj.decode_ms  != null ? `${obj.decode_ms} ms` : '-';
  E.recognize.textContent= obj.recognize_ms!= null ? `${obj.recognize_ms} ms` : '-';
  E.cpuTime.textContent  = obj.cpu_time_ms!= null ? `${obj.cpu_time_ms} ms` : '-';
  E.cpuPct.textContent   = obj.cpu_percent_est!= null ? `${obj.cpu_percent_est}%` : '-';
  E.rss.textContent      = obj.rss_mb     != null ? `${obj.rss_mb} MB` : '-';
  E.rssDelta.textContent = obj.rss_delta_mb!= null ? `${obj.rss_delta_mb} MB` : '-';
  E.aSec.textContent     = obj.audio_seconds!= null ? `${obj.audio_seconds}s` : '-';
  const fb = obj.file_bytes;
  E.fSize.textContent    = fb != null ? bytesToSize(fb) : (file.files[0] ? bytesToSize(file.files[0].size) : '-');
}

file.addEventListener('change', () => {
  const f = file.files[0];
  if(!f) return;

  // å®¢æˆ·ç«¯è¶…é™æ‹¦æˆª
  if (f.size > MAX_BYTES) {
    alert(`æ–‡ä»¶è¿‡å¤§ï¼š${bytesToSize(f.size)}ï¼Œæœ€å¤§å…è®¸ ${MAX_MB} MB`);
    file.value = '';
    return;
  }

  // é‡Šæ”¾æ—§ URL
  if(objectURL){ URL.revokeObjectURL(objectURL); objectURL = null; }

  // åˆ›å»ºæ–°çš„ä¸´æ—¶æ’­æ”¾åœ°å€
  objectURL = URL.createObjectURL(f);
  player.src = objectURL;
  playerRow.style.display = 'flex';
  meta.textContent = `${f.name} Â· ${bytesToSize(f.size)}`;
  player.onloadedmetadata = () => {
    meta.textContent = `${f.name} Â· ${bytesToSize(f.size)} Â· æ—¶é•¿ ${formatSec(player.duration)}`;
  };
});

async function postBlob(blob){
  const fd = new FormData();
  fd.append('audio', blob, blob.name || 'upload.wav');

  outText.textContent = 'â³ æ­£åœ¨è¯†åˆ«ï¼Œè¯·ç¨å€™â€¦';
  setStats({}); // æ¸…ç©º

  const t0 = performance.now();
  try{
    const r = await fetch('/api/stt', {method:'POST', body:fd});
    const j = await r.json();
    const t1 = performance.now();

    if (j.error) {
      outText.textContent = 'âŒ ' + j.error;
      E.rt.textContent = `${Math.round(t1 - t0)} ms`;
      return;
    }

    // æ–‡æœ¬
    outText.textContent = j.text || '(ç©º)';

    // æŒ‡æ ‡
    setStats(j);
    E.rt.textContent = `${Math.round(t1 - t0)} ms`;
  }catch(e){
    outText.textContent = 'âŒ ä¸Šä¼ æˆ–è¯†åˆ«å¤±è´¥ï¼š' + (e.message || e);
  }
}

uploadBtn.onclick = async () => {
  if(!file.files[0]) return alert('å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
  if (file.files[0].size > MAX_BYTES) {
    return alert(`æ–‡ä»¶è¿‡å¤§ï¼š${bytesToSize(file.files[0].size)}ï¼Œæœ€å¤§å…è®¸ ${MAX_MB} MB`);
  }
  await postBlob(file.files[0]);
};

// åˆå§‹åŒ–ï¼šä»åç«¯æ‹‰å– max_file_mb
async function init(){
  try{
    const r = await fetch('/api/health');
    if(r.ok){
      const h = await r.json();
      if (typeof h.max_file_mb === 'number') {
        MAX_MB = h.max_file_mb;
        MAX_BYTES = MAX_MB * 1024 * 1024;
        maxTip.textContent = `${MAX_MB} MB`;
      }
    }
  }catch(_){}
}
init();

// é¡µé¢å¸è½½æ—¶æ¸…ç† URL
window.addEventListener('beforeunload', () => {
  if(objectURL) URL.revokeObjectURL(objectURL);
});
</script>
</body>
</html>
